<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA eSUN DEX Query Validator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .query-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .query-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .query-type-btn:hover {
            border-color: #3498db;
        }

        .query-type-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .state-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .state-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .state-btn:hover {
            border-color: #2ecc71;
        }

        .state-btn.active {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group label .required {
            color: #e74c3c;
            margin-left: 3px;
        }

        .form-group label .optional {
            color: #95a5a6;
            font-size: 12px;
            font-weight: normal;
            margin-left: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
        }

        .form-group input.warning {
            border-color: #f39c12;
        }

        .form-group input:disabled {
            background: #ecf0f1;
            cursor: not-allowed;
        }

        .validate-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .validate-btn:hover {
            background: #2980b9;
        }

        .validate-btn:active {
            transform: translateY(1px);
        }

        .results {
            position: sticky;
            top: 20px;
        }

        .validation-status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .validation-status.valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-status.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .validation-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .error-list {
            list-style: none;
            margin-top: 10px;
        }

        .error-list li {
            padding: 8px 12px;
            background: white;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
            border-left: 3px solid #e74c3c;
        }

        .warning-list li {
            border-left-color: #f39c12;
        }

        .combination-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #90caf9;
        }

        .combination-info h3 {
            font-size: 14px;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .combination-info code {
            display: block;
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .xml-output {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.5;
        }

        .xml-tag {
            color: #82aaff;
        }

        .xml-attr {
            color: #c792ea;
        }

        .xml-value {
            color: #c3e88d;
        }

        .field-requirements {
            background: #fff9e6;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #ffe082;
        }

        .field-requirements h3 {
            font-size: 14px;
            color: #f57c00;
            margin-bottom: 10px;
        }

        .field-requirements ul {
            margin-left: 20px;
            font-size: 13px;
        }

        .field-requirements li {
            margin-bottom: 5px;
        }

        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .results {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CA eSUN DEX Query Validator</h1>
            <p>Validate person and vehicle queries for California Chula Vista eSUN system</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>Query Configuration</h2>

                <div class="query-type-selector">
                    <button class="query-type-btn active" data-type="vehicle-registration">Vehicle Registration</button>
                    <button class="query-type-btn" data-type="driver-license">Driver License</button>
                    <button class="query-type-btn" data-type="driver-history">Driver History</button>
                    <button class="query-type-btn" data-type="article">Article</button>
                </div>

                <div class="state-selector" id="state-selector">
                    <button class="state-btn active" data-state="in-state">In-State (CA)</button>
                    <button class="state-btn" data-state="out-of-state">Out-of-State</button>
                </div>

                <div id="form-fields"></div>

                <button class="validate-btn" onclick="validateQuery()">Validate Query</button>
            </div>

            <div class="section results">
                <h2>Validation Results</h2>
                <div id="validation-results">
                    <div class="validation-status" style="background: #e8f4f8; color: #546e7a; border-color: #b0bec5;">
                        Enter query details and click "Validate Query" to see results
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Query specifications based on CA eSUN documentation
        const querySpecs = {
            'driver-license': {
                name: 'Driver License Query',
                combinations: [
                    {
                        id: 1,
                        description: '(In) Name',
                        fields: ['name'],
                        state: 'in-state'
                    },
                    {
                        id: 2,
                        description: '(In) OperatorLicenseNumber',
                        fields: ['operatorLicenseNumber'],
                        state: 'in-state'
                    },
                    {
                        id: 3,
                        description: '(In/Out) BirthDate, Name, SexCode, [State]',
                        fields: ['birthDate', 'name', 'sexCode'],
                        optionalFields: ['state'],
                        state: 'both'
                    },
                    {
                        id: 4,
                        description: '(In/Out) OperatorLicenseNumber, [State]',
                        fields: ['operatorLicenseNumber'],
                        optionalFields: ['state'],
                        state: 'both'
                    }
                ]
            },
            'driver-history': {
                name: 'Driver History Query',
                combinations: [
                    {
                        id: 1,
                        description: '(In) Name',
                        fields: ['name'],
                        state: 'in-state'
                    },
                    {
                        id: 2,
                        description: '(In) OperatorLicenseNumber',
                        fields: ['operatorLicenseNumber'],
                        state: 'in-state'
                    },
                    {
                        id: 3,
                        description: '(In/Out) BirthDate, Name, SexCode, [State]',
                        fields: ['birthDate', 'name', 'sexCode'],
                        optionalFields: ['state'],
                        state: 'both'
                    },
                    {
                        id: 4,
                        description: '(In/Out) OperatorLicenseNumber, [State]',
                        fields: ['operatorLicenseNumber'],
                        optionalFields: ['state'],
                        state: 'both'
                    }
                ]
            },
            'vehicle-registration': {
                name: 'Vehicle Registration Query',
                combinations: [
                    {
                        id: 1,
                        description: '(In) LicensePlateNumber, LicensePlateTypeCode',
                        fields: ['licensePlateNumber', 'licensePlateTypeCode'],
                        state: 'in-state'
                    },
                    {
                        id: 2,
                        description: '(In/Out) LicensePlateNumber, LicensePlateTypeCode, LicensePlateYear, [State]',
                        fields: ['licensePlateNumber', 'licensePlateTypeCode', 'licensePlateYear'],
                        optionalFields: ['state'],
                        state: 'both'
                    },
                    {
                        id: 3,
                        description: '(In) VehicleIdentificationNumber, [VehicleMakeCode or VehicleYear]',
                        fields: ['vehicleIdentificationNumber'],
                        optionalFields: ['vehicleMakeCode', 'vehicleYear'],
                        state: 'in-state'
                    },
                    {
                        id: 4,
                        description: '(In/Out) VehicleIdentificationNumber, [VehicleMakeCode, VehicleYear, or State]',
                        fields: ['vehicleIdentificationNumber'],
                        optionalFields: ['state', 'vehicleMakeCode', 'vehicleYear'],
                        state: 'both'
                    }
                ]
            },
            'article': {
                name: 'Article Query',
                combinations: [
                    {
                        id: 1,
                        description: 'ArticleSerialNumber + ArticleBrand',
                        fields: ['articleSerialNumber', 'articleBrand'],
                        optionalFields: [],
                        state: 'both'
                    },
                    {
                        id: 2,
                        description: 'ArticleSerialNumber + ArticleTypeCode + ArticleCategory',
                        fields: ['articleSerialNumber', 'articleTypeCode', 'articleCategory'],
                        optionalFields: [],
                        state: 'both'
                    },
                    {
                        id: 3,
                        description: 'ArticleSerialNumber + ArticleTypeCode + ArticleCategory + ArticleBrand',
                        fields: ['articleSerialNumber', 'articleTypeCode', 'articleCategory', 'articleBrand'],
                        optionalFields: [],
                        state: 'both'
                    }
                ]
            }
        };

        // Field definitions
        const fieldDefinitions = {
            name: {
                label: 'Name',
                type: 'text',
                placeholder: 'Last, First Middle',
                hint: 'Format: LAST, FIRST MIDDLE'
            },
            operatorLicenseNumber: {
                label: "Operator's License Number",
                type: 'text',
                placeholder: '',
                hint: 'Driver license number'
            },
            birthDate: {
                label: 'Birth Date',
                type: 'date',
                placeholder: 'YYYY-MM-DD',
                hint: 'Date of birth'
            },
            sexCode: {
                label: 'Sex Code',
                type: 'select',
                options: [
                    { value: '', label: 'Select...' },
                    { value: 'M', label: 'M - Male' },
                    { value: 'F', label: 'F - Female' },
                    { value: 'U', label: 'U - Unknown' }
                ],
                hint: 'Gender'
            },
            state: {
                label: 'State',
                type: 'datalist',
                placeholder: 'Type or select...',
                hint: '<strong>If License Plate State is CA leave blank.</strong> Otherwise choose appropriate 2 letter state code',
                maxLength: 2,
                options: [
                    { value: 'AL', label: 'AL - Alabama' },
                    { value: 'AK', label: 'AK - Alaska' },
                    { value: 'AZ', label: 'AZ - Arizona' },
                    { value: 'AR', label: 'AR - Arkansas' },
                    { value: 'CA', label: 'CA - California' },
                    { value: 'CO', label: 'CO - Colorado' },
                    { value: 'CT', label: 'CT - Connecticut' },
                    { value: 'DE', label: 'DE - Delaware' },
                    { value: 'FL', label: 'FL - Florida' },
                    { value: 'GA', label: 'GA - Georgia' },
                    { value: 'HI', label: 'HI - Hawaii' },
                    { value: 'ID', label: 'ID - Idaho' },
                    { value: 'IL', label: 'IL - Illinois' },
                    { value: 'IN', label: 'IN - Indiana' },
                    { value: 'IA', label: 'IA - Iowa' },
                    { value: 'KS', label: 'KS - Kansas' },
                    { value: 'KY', label: 'KY - Kentucky' },
                    { value: 'LA', label: 'LA - Louisiana' },
                    { value: 'ME', label: 'ME - Maine' },
                    { value: 'MD', label: 'MD - Maryland' },
                    { value: 'MA', label: 'MA - Massachusetts' },
                    { value: 'MI', label: 'MI - Michigan' },
                    { value: 'MN', label: 'MN - Minnesota' },
                    { value: 'MS', label: 'MS - Mississippi' },
                    { value: 'MO', label: 'MO - Missouri' },
                    { value: 'MT', label: 'MT - Montana' },
                    { value: 'NE', label: 'NE - Nebraska' },
                    { value: 'NV', label: 'NV - Nevada' },
                    { value: 'NH', label: 'NH - New Hampshire' },
                    { value: 'NJ', label: 'NJ - New Jersey' },
                    { value: 'NM', label: 'NM - New Mexico' },
                    { value: 'NY', label: 'NY - New York' },
                    { value: 'NC', label: 'NC - North Carolina' },
                    { value: 'ND', label: 'ND - North Dakota' },
                    { value: 'OH', label: 'OH - Ohio' },
                    { value: 'OK', label: 'OK - Oklahoma' },
                    { value: 'OR', label: 'OR - Oregon' },
                    { value: 'PA', label: 'PA - Pennsylvania' },
                    { value: 'RI', label: 'RI - Rhode Island' },
                    { value: 'SC', label: 'SC - South Carolina' },
                    { value: 'SD', label: 'SD - South Dakota' },
                    { value: 'TN', label: 'TN - Tennessee' },
                    { value: 'TX', label: 'TX - Texas' },
                    { value: 'UT', label: 'UT - Utah' },
                    { value: 'VT', label: 'VT - Vermont' },
                    { value: 'VA', label: 'VA - Virginia' },
                    { value: 'WA', label: 'WA - Washington' },
                    { value: 'WV', label: 'WV - West Virginia' },
                    { value: 'WI', label: 'WI - Wisconsin' },
                    { value: 'WY', label: 'WY - Wyoming' },
                    { value: 'DC', label: 'DC - District of Columbia' },
                    { value: 'PR', label: 'PR - Puerto Rico' }
                ]
            },
            licensePlateNumber: {
                label: 'License Plate Number',
                type: 'text',
                placeholder: '',
                hint: 'License plate number (max 10 characters)',
                maxLength: 10
            },
            licensePlateTypeCode: {
                label: 'License Plate Type Code',
                type: 'text',
                placeholder: '',
                hint: 'Plate type (e.g., PC=Passenger Car, CM=Commercial)',
                maxLength: 2
            },
            licensePlateYear: {
                label: 'License Plate Year',
                type: 'text',
                placeholder: '',
                hint: 'Year of plate registration (4 digits)',
                maxLength: 4
            },
            vehicleIdentificationNumber: {
                label: 'Vehicle Identification Number (VIN)',
                type: 'text',
                placeholder: '',
                hint: 'Vehicle Identification Number (up to 30 characters)',
                maxLength: 30
            },
            vehicleMakeCode: {
                label: 'Vehicle Make Code',
                type: 'text',
                placeholder: '',
                hint: 'Vehicle make code (4 characters)',
                maxLength: 4
            },
            vehicleYear: {
                label: 'Vehicle Year',
                type: 'text',
                placeholder: '',
                hint: 'Vehicle year (4 digits)',
                maxLength: 4
            },
            purposeCode: {
                label: 'CA Purpose Code',
                type: 'select',
                options: [
                    { value: '', label: 'Select...' },
                    { value: 'C', label: 'C - Criminal' },
                    { value: 'I', label: 'I - Intelligence' },
                    { value: 'U', label: 'U - Immigration Violations (Section 1325)' }
                ],
                hint: 'Required per AB 1747 (mandatory since July 21, 2021)',
                required: true
            },
            articleSerialNumber: {
                label: 'Article Serial Number',
                type: 'text',
                placeholder: '',
                hint: 'Article serial number (max 20 characters)',
                maxLength: 20
            },
            articleTypeCode: {
                label: 'Article Type Code',
                type: 'select',
                options: [
                    { value: '', label: 'Select...' },
                    { value: 'BCYCL', label: 'BCYCL' },
                    { value: 'LAPTOP', label: 'LAPTOP' }
                ],
                hint: 'Article type code (max 6 characters)'
            },
            articleBrand: {
                label: 'Article Brand',
                type: 'select',
                options: [
                    { value: '', label: 'Select...' },
                    { value: 'SCHWINN', label: 'SCHWINN' },
                    { value: 'DELL', label: 'DELL' }
                ],
                hint: 'Article brand (max 6 characters)'
            },
            articleCategory: {
                label: 'Article Category',
                type: 'select',
                options: [
                    { value: '', label: 'Select...' },
                    { value: 'B', label: 'B' },
                    { value: 'D', label: 'D' }
                ],
                hint: 'Article category (max 1 character)'
            }
        };

        let currentQueryType = 'vehicle-registration';
        let currentState = 'in-state';
        let formData = {};
        let vinErrorAcknowledged = false;
        let vinErrorMessage = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            renderForm();
        });

        function setupEventListeners() {
            // Query type buttons
            document.querySelectorAll('.query-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.query-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentQueryType = this.dataset.type;

                    // Auto-determine state mode for vehicle registration based on State field
                    if (currentQueryType === 'vehicle-registration') {
                        const stateValue = formData.state ? formData.state.trim().toUpperCase() : '';
                        if (stateValue === '' || stateValue === 'CA') {
                            currentState = 'in-state';
                        } else {
                            currentState = 'out-of-state';
                        }
                    }

                    renderForm();

                    // Auto-focus on CA Purpose Code field for vehicle registration
                    if (currentQueryType === 'vehicle-registration') {
                        setTimeout(() => {
                            const purposeCodeField = document.getElementById('purposeCode');
                            if (purposeCodeField) {
                                purposeCodeField.focus();
                            }
                        }, 0);
                    }
                });
            });

            // State buttons
            document.querySelectorAll('.state-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentState = this.dataset.state;
                    renderForm();
                });
            });
        }

        function renderForm() {
            const formContainer = document.getElementById('form-fields');
            const spec = querySpecs[currentQueryType];

            // Hide/show state selector based on query type
            // For vehicle-registration, hide selector as state is determined by State field value
            const stateSelector = document.getElementById('state-selector');
            if (currentQueryType === 'article' || currentQueryType === 'vehicle-registration') {
                stateSelector.style.display = 'none';
            } else {
                stateSelector.style.display = 'flex';
            }

            // Get all possible fields for this query type
            const allFields = new Set();
            spec.combinations.forEach(combo => {
                combo.fields.forEach(f => allFields.add(f));
                if (combo.optionalFields) {
                    combo.optionalFields.forEach(f => allFields.add(f));
                }
            });

            // Always add purposeCode
            allFields.add('purposeCode');

            // Define field order based on query type
            let fieldOrder;
            if (currentQueryType === 'article') {
                fieldOrder = ['purposeCode', 'articleSerialNumber', 'articleTypeCode', 'articleCategory', 'articleBrand'];
            } else if (currentQueryType === 'vehicle-registration') {
                // Specific order for vehicle registration: Purpose Code, State, then Plate/VIN fields
                fieldOrder = ['purposeCode', 'state', 'licensePlateNumber', 'licensePlateTypeCode', 'licensePlateYear',
                             'vehicleIdentificationNumber', 'vehicleMakeCode', 'vehicleYear'];
            } else {
                // For other query types, convert Set to Array
                fieldOrder = Array.from(allFields);
            }

            // Filter fieldOrder to only include fields that exist in allFields
            let orderedFields = fieldOrder.filter(f => allFields.has(f));

            // Ensure purposeCode is always first
            orderedFields = orderedFields.filter(f => f !== 'purposeCode');
            if (allFields.has('purposeCode')) {
                orderedFields.unshift('purposeCode');
            }

            let html = '';

            orderedFields.forEach(fieldName => {
                const field = fieldDefinitions[fieldName];
                if (!field) return;

                // Vehicle registration field visibility logic
                if (currentQueryType === 'vehicle-registration') {
                    // Add "AND" separator between CA Purpose Code and State
                    if (fieldName === 'state') {
                        html += `
                            <div style="text-align: center; margin: 20px 0; position: relative;">
                                <div style="border-top: 2px solid #ddd; position: absolute; top: 50%; left: 0; right: 0; z-index: 0;"></div>
                                <span style="background: #f8f9fa; padding: 0 15px; position: relative; z-index: 1; font-weight: 600; color: #2ecc71; font-size: 14px;">AND</span>
                            </div>
                        `;
                    }

                    const hasPlateNumber = formData.licensePlateNumber && formData.licensePlateNumber.trim() !== '';
                    const hasVIN = formData.vehicleIdentificationNumber && formData.vehicleIdentificationNumber.trim() !== '';

                    // Add "THEN" separator between State and License Plate Number
                    if (fieldName === 'licensePlateNumber') {
                        html += `
                            <div style="text-align: center; margin: 20px 0; position: relative;">
                                <div style="border-top: 2px solid #ddd; position: absolute; top: 50%; left: 0; right: 0; z-index: 0;"></div>
                                <span style="background: #f8f9fa; padding: 0 15px; position: relative; z-index: 1; font-weight: 600; color: #3498db; font-size: 14px;">THEN</span>
                            </div>
                        `;
                    }

                    // Add "OR" separator before VIN field (only if neither field has data yet)
                    if (fieldName === 'vehicleIdentificationNumber' && !hasPlateNumber && !hasVIN) {
                        html += `
                            <div style="text-align: center; margin: 20px 0; position: relative;">
                                <div style="border-top: 2px solid #ddd; position: absolute; top: 50%; left: 0; right: 0; z-index: 0;"></div>
                                <span style="background: #f8f9fa; padding: 0 15px; position: relative; z-index: 1; font-weight: 600; color: #666; font-size: 14px;">OR</span>
                            </div>
                        `;
                    }

                    // Hide plate detail fields if no plate number entered yet
                    if (!hasPlateNumber && (fieldName === 'licensePlateTypeCode' || fieldName === 'licensePlateYear')) {
                        return; // Skip rendering these fields
                    }

                    // Hide VIN detail fields if no VIN entered yet
                    if (!hasVIN && (fieldName === 'vehicleMakeCode' || fieldName === 'vehicleYear')) {
                        return; // Skip rendering these fields
                    }

                    // Hide VIN and its detail fields if license plate number has data
                    if (hasPlateNumber && (fieldName === 'vehicleIdentificationNumber' || fieldName === 'vehicleMakeCode' || fieldName === 'vehicleYear')) {
                        return; // Skip rendering these fields
                    }

                    // Hide plate and its detail fields if VIN has data
                    if (hasVIN && (fieldName === 'licensePlateNumber' || fieldName === 'licensePlateTypeCode' || fieldName === 'licensePlateYear')) {
                        return; // Skip rendering these fields
                    }
                }

                const isRequired = fieldName === 'purposeCode';

                // Set default value for licensePlateYear to current year if not already set
                let value = formData[fieldName] || '';
                if (fieldName === 'licensePlateYear' && !value) {
                    value = new Date().getFullYear().toString();
                    formData[fieldName] = value;
                }

                html += `
                    <div class="form-group">
                        <label>
                            ${field.label}
                            ${isRequired ? '<span class="required">*</span>' : ''}
                        </label>
                `;

                if (field.type === 'select') {
                    html += `<select id="${fieldName}" onchange="updateFormData('${fieldName}', this.value)">`;
                    field.options.forEach(opt => {
                        html += `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`;
                    });
                    html += `</select>`;
                } else if (field.type === 'datalist') {
                    const attrs = field.maxLength ? `maxlength="${field.maxLength}"` : '';
                    const datalistId = `${fieldName}-list`;
                    html += `<input type="text" id="${fieldName}" list="${datalistId}" placeholder="${field.placeholder}" value="${value}" ${attrs} oninput="updateFormData('${fieldName}', this.value)" style="text-transform: uppercase;">`;
                    html += `<datalist id="${datalistId}">`;
                    if (field.options) {
                        field.options.forEach(opt => {
                            html += `<option value="${opt.value}">${opt.label}</option>`;
                        });
                    }
                    html += `</datalist>`;
                } else {
                    const attrs = field.maxLength ? `maxlength="${field.maxLength}"` : '';
                    // Add onblur handlers for license plate and VIN fields to trigger field showing/hiding
                    let blurHandler = '';
                    if (fieldName === 'licensePlateNumber') {
                        blurHandler = ` onblur="handleLicensePlateBlur()"`;
                    } else if (fieldName === 'vehicleIdentificationNumber') {
                        blurHandler = ` onblur="handleVINBlur()"`;
                    }
                    html += `<input type="${field.type}" id="${fieldName}" placeholder="${field.placeholder}" value="${value}" ${attrs} oninput="updateFormData('${fieldName}', this.value)"${blurHandler}>`;
                }

                // Add hint text if available
                if (field.hint) {
                    html += `<small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">${field.hint}</small>`;
                }

                html += `</div>`;
            });

            formContainer.innerHTML = html;
        }

        function updateFormData(field, value) {
            formData[field] = value;

            // Auto-focus on State field when CA Purpose Code is selected
            if (field === 'purposeCode' && value && currentQueryType === 'vehicle-registration') {
                setTimeout(() => {
                    const stateField = document.getElementById('state');
                    if (stateField) {
                        stateField.focus();
                    }
                }, 0);
            }

            // Reset VIN error state when VIN field changes
            if (field === 'vehicleIdentificationNumber') {
                vinErrorAcknowledged = false;
                vinErrorMessage = '';
                // Remove error styling and message
                const vinField = document.getElementById('vehicleIdentificationNumber');
                if (vinField) {
                    vinField.classList.remove('error');
                }
                const existingError = document.getElementById('vin-error-message');
                if (existingError) {
                    existingError.remove();
                }
            }

            // Auto-determine In-State vs Out-of-State for vehicle registration based on State field
            if (currentQueryType === 'vehicle-registration' && field === 'state') {
                const stateValue = value ? value.trim().toUpperCase() : '';
                if (stateValue === '' || stateValue === 'CA') {
                    currentState = 'in-state';
                } else {
                    currentState = 'out-of-state';
                }
            }
        }

        function acknowledgeVINError() {
            vinErrorAcknowledged = true;
            vinErrorMessage = ''; // Clear error message after acknowledgment
            handleVINBlur(); // Re-run the blur handler to proceed with form updates
        }

        function handleLicensePlateBlur() {
            // Re-render form when user exits license plate number field
            if (currentQueryType === 'vehicle-registration') {
                const plateValue = formData.licensePlateNumber;
                // Clear VIN-related fields when license plate is entered
                if (plateValue && plateValue.trim() !== '') {
                    formData.vehicleIdentificationNumber = '';
                    formData.vehicleMakeCode = '';
                    formData.vehicleYear = '';
                }
                renderForm();

                // Auto-focus on License Plate Type Code field after form renders
                if (plateValue && plateValue.trim() !== '') {
                    setTimeout(() => {
                        const plateTypeField = document.getElementById('licensePlateTypeCode');
                        if (plateTypeField) {
                            plateTypeField.focus();
                        }
                    }, 0);
                }
            }
        }

        function validateVIN(vin) {
            // VIN validation according to ISO 3779:2009
            if (!vin || vin.trim() === '') {
                return { valid: true, error: '' }; // Empty is valid (optional field)
            }

            const vinUpper = vin.toUpperCase().trim();

            // Check length - must be exactly 17 characters
            if (vinUpper.length < 17) {
                return {
                    valid: false,
                    error: `VIN is too short (${vinUpper.length} characters). A valid VIN must be exactly 17 characters.`
                };
            }
            if (vinUpper.length > 17) {
                return {
                    valid: false,
                    error: `VIN is too long (${vinUpper.length} characters). A valid VIN must be exactly 17 characters.`
                };
            }

            // Check for invalid characters (I, O, Q are not allowed per ISO 3779)
            const invalidChars = vinUpper.match(/[IOQ]/g);
            if (invalidChars) {
                const uniqueInvalid = [...new Set(invalidChars)].join(', ');
                return {
                    valid: false,
                    error: `VIN contains invalid character(s): ${uniqueInvalid}. Letters I, O, and Q are not allowed in VINs (to avoid confusion with 1, 0).`
                };
            }

            // Check that all characters are alphanumeric
            const invalidPattern = vinUpper.match(/[^A-HJ-NPR-Z0-9]/g);
            if (invalidPattern) {
                const uniqueInvalid = [...new Set(invalidPattern)].join(', ');
                return {
                    valid: false,
                    error: `VIN contains invalid character(s): ${uniqueInvalid}. Only letters A-Z (except I, O, Q) and numbers 0-9 are allowed.`
                };
            }

            return { valid: true, error: '' };
        }

        function addVINError() {
            // Helper function to add VIN error message to DOM
            const vinField = document.getElementById('vehicleIdentificationNumber');
            if (!vinField || !vinErrorMessage) return;

            // Remove any existing error message first
            const existingError = document.getElementById('vin-error-message');
            if (existingError) {
                existingError.remove();
            }

            vinField.classList.add('error');

            // Add error message with acknowledgment button
            const errorContainer = document.createElement('div');
            errorContainer.id = 'vin-error-message';
            errorContainer.style.marginTop = '8px';

            const errorMsg = document.createElement('div');
            errorMsg.style.color = '#e74c3c';
            errorMsg.style.fontSize = '12px';
            errorMsg.style.fontWeight = '500';
            errorMsg.style.marginBottom = '8px';
            errorMsg.textContent = vinErrorMessage;

            const acknowledgeBtn = document.createElement('button');
            acknowledgeBtn.textContent = 'Proceed Anyway';
            acknowledgeBtn.style.padding = '6px 12px';
            acknowledgeBtn.style.backgroundColor = '#f39c12';
            acknowledgeBtn.style.color = 'white';
            acknowledgeBtn.style.border = 'none';
            acknowledgeBtn.style.borderRadius = '4px';
            acknowledgeBtn.style.fontSize = '12px';
            acknowledgeBtn.style.fontWeight = '600';
            acknowledgeBtn.style.cursor = 'pointer';
            acknowledgeBtn.onclick = acknowledgeVINError;

            errorContainer.appendChild(errorMsg);
            errorContainer.appendChild(acknowledgeBtn);
            vinField.parentElement.appendChild(errorContainer);
        }

        function handleVINBlur() {
            // Validate VIN according to ISO 3779:2009
            const vinValue = formData.vehicleIdentificationNumber;
            const vinField = document.getElementById('vehicleIdentificationNumber');

            if (vinValue && vinValue.trim() !== '') {
                const validation = validateVIN(vinValue);

                if (!validation.valid) {
                    // Store error message
                    vinErrorMessage = validation.error;

                    // Add error message
                    addVINError();

                    // Block form progression until error is acknowledged
                    if (!vinErrorAcknowledged) {
                        return;
                    }
                } else {
                    // Clear error state for valid VIN
                    vinErrorMessage = '';
                    vinErrorAcknowledged = false;
                    if (vinField) {
                        vinField.classList.remove('error');
                    }
                    const existingError = document.getElementById('vin-error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                }
            } else {
                // Clear error state when field is empty
                vinErrorMessage = '';
                if (vinField) {
                    vinField.classList.remove('error');
                }
                const existingError = document.getElementById('vin-error-message');
                if (existingError) {
                    existingError.remove();
                }
            }

            // Re-render form when user exits VIN field (only if valid or acknowledged)
            if (currentQueryType === 'vehicle-registration') {
                // Clear plate-related fields when VIN is entered
                if (vinValue && vinValue.trim() !== '') {
                    formData.licensePlateNumber = '';
                    formData.licensePlateTypeCode = '';
                    formData.licensePlateYear = '';
                }
                renderForm();

                // Auto-focus on Vehicle Make Code field after form renders
                if (vinValue && vinValue.trim() !== '') {
                    setTimeout(() => {
                        const makeCodeField = document.getElementById('vehicleMakeCode');
                        if (makeCodeField) {
                            makeCodeField.focus();
                        }
                    }, 0);
                }
            }
        }

        function validateQuery() {
            const spec = querySpecs[currentQueryType];
            const results = {
                valid: false,
                errors: [],
                warnings: [],
                matchedCombination: null,
                xml: ''
            };

            // Check CA Purpose Code (always required per AB 1747)
            if (!formData.purposeCode) {
                results.errors.push('CA Purpose Code is mandatory per AB 1747 (required since July 21, 2021)');
            }

            // Get filled fields (excluding purposeCode for combination matching)
            const filledFields = Object.keys(formData).filter(key => {
                return formData[key] && formData[key].trim() !== '' && key !== 'purposeCode';
            });

            if (filledFields.length === 0) {
                results.errors.push('At least one query field must be provided');
                displayResults(results);
                return;
            }

            // Check for valid combinations
            let invalidFieldsList = [];
            let missingFieldsList = [];

            const validCombinations = spec.combinations.filter(combo => {
                // Check if combination is valid for current state
                if (combo.state === 'in-state' && currentState !== 'in-state') return false;
                if (combo.state === 'out-of-state' && currentState !== 'out-of-state') return false;

                // Get all allowed fields for this combination
                const allowedFields = [...combo.fields];
                if (combo.optionalFields) {
                    allowedFields.push(...combo.optionalFields);
                }

                // Check if all filled fields are allowed
                const invalidFields = filledFields.filter(f => !allowedFields.includes(f));
                if (invalidFields.length > 0) {
                    invalidFieldsList = [...new Set([...invalidFieldsList, ...invalidFields])];
                    return false;
                }

                // Check if all required fields are filled
                const missingRequired = combo.fields.filter(f => !filledFields.includes(f));
                if (missingRequired.length > 0) {
                    missingFieldsList = [...new Set([...missingFieldsList, ...missingRequired])];
                    return false;
                }

                return true;
            });

            if (validCombinations.length === 0) {
                // Provide specific feedback about what's wrong
                if (invalidFieldsList.length > 0) {
                    const fieldLabels = invalidFieldsList.map(f => {
                        const def = fieldDefinitions[f];
                        return def ? `"${def.label}"` : f;
                    }).join(', ');

                    // Special handling for State field in in-state queries
                    if (currentState === 'in-state' && invalidFieldsList.includes('state')) {
                        results.errors.push(`âŒ State field must be REMOVED for in-state California queries. Clear the State field value.`);
                    } else {
                        results.errors.push(`âŒ Invalid field(s) for this combination: ${fieldLabels}`);
                    }
                }

                if (missingFieldsList.length > 0 && invalidFieldsList.length === 0) {
                    const fieldLabels = missingFieldsList.map(f => {
                        const def = fieldDefinitions[f];
                        return def ? `"${def.label}"` : f;
                    }).join(', ');
                    results.errors.push(`âŒ Missing required field(s): ${fieldLabels}`);
                }

                if (invalidFieldsList.length === 0 && missingFieldsList.length === 0) {
                    results.errors.push('The provided field combination is not valid for this query type and state selection');
                }

                results.errors.push('ðŸ“‹ Valid combinations are listed in the Field Requirements section below');
            } else {
                results.valid = true;
                results.matchedCombination = validCombinations[0];

                // State field validation
                if (currentState === 'in-state' && formData.state) {
                    if (formData.state.toUpperCase() === 'CA') {
                        results.warnings.push('State field "CA" should be omitted for in-state California queries');
                    } else {
                        results.errors.push(`State field "${formData.state}" should not be used for in-state queries. Remove the State field or switch to Out-of-State mode.`);
                        results.valid = false;
                    }
                }

                if (currentState === 'out-of-state' && !formData.state) {
                    // Check if state is optional or required for this combination
                    const combo = results.matchedCombination;
                    if (combo.optionalFields && combo.optionalFields.includes('state')) {
                        results.warnings.push('State field is recommended for out-of-state queries to ensure proper routing');
                    }
                }
            }

            // Generate XML if valid
            if (results.valid || results.warnings.length > 0) {
                results.xml = generateXML(spec.name, formData, currentState);
            }

            displayResults(results);
        }

        function generateXML(queryType, data, state) {
            const queryTypeTag = queryType.replace(/ /g, '');

            // Generate Request wrapper structure
            let xml = `<Request>\n`;
            xml += `  <MessageType>${queryTypeTag}</MessageType>\n`;
            xml += `  <Id>MARK43GENERATEDMSGID</Id>\n`;

            // Add CaRequestPurposeCode (always required per CA AB 1747)
            if (data.purposeCode) {
                xml += `  <CaRequestPurposeCode>${data.purposeCode}</CaRequestPurposeCode>\n`;
            }

            // Add other fields in appropriate order
            // Order: Name, BirthDate, SexCode, OperatorLicenseNumber, State, then vehicle fields, then article fields
            const fieldOrder = ['name', 'birthDate', 'sexCode', 'operatorLicenseNumber', 'state',
                               'licensePlateNumber', 'licensePlateTypeCode', 'licensePlateYear',
                               'vehicleIdentificationNumber', 'vehicleMakeCode', 'vehicleYear',
                               'articleSerialNumber', 'articleTypeCode', 'articleCategory', 'articleBrand'];

            fieldOrder.forEach(key => {
                if (key === 'purposeCode' || !data[key]) return;

                const value = data[key];

                // Map internal field names to CA eSUN XML field names
                if (key === 'name') {
                    // Name field is sent as-is per CA eSUN spec (format: LAST, FIRST MIDDLE)
                    xml += `  <Name>${value}</Name>\n`;
                } else if (key === 'birthDate') {
                    // Convert YYYY-MM-DD to YYYYMMDD format
                    const dateFormatted = value.replace(/-/g, '');
                    xml += `  <BirthDate>${dateFormatted}</BirthDate>\n`;
                } else if (key === 'sexCode') {
                    xml += `  <SexCode>${value}</SexCode>\n`;
                } else if (key === 'operatorLicenseNumber') {
                    xml += `  <OperatorLicenseNumber>${value}</OperatorLicenseNumber>\n`;
                } else if (key === 'state') {
                    // CRITICAL: Never include State field for in-state CA queries per CA eSUN spec
                    // Only include State field for out-of-state queries
                    if (state === 'out-of-state' && value) {
                        xml += `  <State>${value.toUpperCase()}</State>\n`;
                    }
                    // For in-state queries: State field is always omitted, even if user entered a value
                } else if (key === 'licensePlateNumber') {
                    xml += `  <LicensePlateNumber>${value}</LicensePlateNumber>\n`;
                } else if (key === 'licensePlateTypeCode') {
                    xml += `  <LicensePlateTypeCode>${value}</LicensePlateTypeCode>\n`;
                } else if (key === 'licensePlateYear') {
                    xml += `  <LicensePlateYear>${value}</LicensePlateYear>\n`;
                } else if (key === 'vehicleIdentificationNumber') {
                    xml += `  <VehicleIdentificationNumber>${value}</VehicleIdentificationNumber>\n`;
                } else if (key === 'vehicleMakeCode') {
                    xml += `  <VehicleMakeCode>${value}</VehicleMakeCode>\n`;
                } else if (key === 'vehicleYear') {
                    xml += `  <VehicleYear>${value}</VehicleYear>\n`;
                } else if (key === 'articleSerialNumber') {
                    xml += `  <ArticleSerialNumber>${value}</ArticleSerialNumber>\n`;
                } else if (key === 'articleTypeCode') {
                    xml += `  <ArticleTypeCode>${value}</ArticleTypeCode>\n`;
                } else if (key === 'articleCategory') {
                    xml += `  <ArticleCategory>${value}</ArticleCategory>\n`;
                } else if (key === 'articleBrand') {
                    xml += `  <ArticleBrand>${value}</ArticleBrand>\n`;
                }
            });

            xml += `</Request>`;

            return xml;
        }

        function displayResults(results) {
            const container = document.getElementById('validation-results');
            let html = '';

            // Validation status
            if (results.valid && results.errors.length === 0) {
                html += `<div class="validation-status valid">âœ“ Query is valid and ready to submit</div>`;
            } else if (results.errors.length > 0) {
                html += `<div class="validation-status invalid">âœ— Query has validation errors</div>`;
            }

            // Errors
            if (results.errors.length > 0) {
                html += `<ul class="error-list">`;
                results.errors.forEach(error => {
                    html += `<li>âŒ ${error}</li>`;
                });
                html += `</ul>`;
            }

            // Warnings
            if (results.warnings.length > 0) {
                html += `<ul class="error-list warning-list">`;
                results.warnings.forEach(warning => {
                    html += `<li>âš ï¸ ${warning}</li>`;
                });
                html += `</ul>`;
            }

            // Matched combination
            if (results.matchedCombination) {
                html += `<div class="combination-info">`;
                html += `<h3>Matched Valid Combination</h3>`;
                html += `<code>${results.matchedCombination.description}</code>`;
                html += `</div>`;
            }

            // XML output
            if (results.xml) {
                html += `<h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">Expected XML Output</h3>`;
                html += `<div class="xml-output">${escapeHtml(results.xml)}</div>`;
            }

            // Field requirements
            html += generateFieldRequirements();

            container.innerHTML = html;
        }

        function generateFieldRequirements() {
            const spec = querySpecs[currentQueryType];
            let html = `<div class="field-requirements">`;

            // Title with or without state mode
            const stateText = currentQueryType === 'article' ? '' : ` (${currentState === 'in-state' ? 'In-State CA' : 'Out-of-State'})`;
            html += `<h3>Valid Field Combinations for ${spec.name}${stateText}</h3>`;

            html += `<p style="margin-bottom: 12px; font-size: 13px; color: #555; line-height: 1.6;">`;
            html += `You must provide <strong>exactly one</strong> of the following field combinations. `;
            html += `Choose the combination that matches the information you have available:`;
            html += `</p>`;

            html += `<ul style="line-height: 1.8;">`;

            spec.combinations.forEach(combo => {
                if (combo.state === 'in-state' && currentState !== 'in-state') return;
                if (combo.state === 'out-of-state' && currentState !== 'out-of-state') return;
                if (combo.state === 'both' || combo.state === currentState) {
                    // Parse the description to add explanations
                    let explanation = '';
                    if (combo.description.includes('Name') && combo.description.includes('BirthDate')) {
                        explanation = ' - Use when you have demographic information but no license number';
                    } else if (combo.description.includes('OperatorLicenseNumber') && !combo.description.includes(',')) {
                        explanation = ' - Use when you have a driver license number';
                    } else if (combo.description === '(In) Name') {
                        explanation = ' - Use for name-only searches (in-state California only)';
                    } else if (combo.description.includes('RegistrationPlate')) {
                        explanation = ' - Use when you have a license plate number';
                    } else if (combo.description.includes('VIN') && !combo.description.includes(',')) {
                        explanation = ' - Use when you have a Vehicle Identification Number';
                    } else if (combo.description.includes('BoatRegistrationNumber') && !combo.description.includes(',')) {
                        explanation = ' - Use when you have a boat/vessel registration number';
                    } else if (combo.description.includes('Name,')) {
                        explanation = ' - Use for owner name + identifier searches (in-state only)';
                    }

                    html += `<li style="margin-bottom: 8px;"><strong>${combo.description}</strong><span style="color: #777;">${explanation}</span></li>`;
                }
            });

            html += `</ul>`;

            // Only show legend for non-article queries
            if (currentQueryType !== 'article') {
                html += `<div style="margin-top: 15px; padding: 12px; background: #f0f8ff; border-left: 3px solid #3498db; border-radius: 4px;">`;
                html += `<p style="font-size: 12px; color: #555; margin-bottom: 8px;"><strong>Legend:</strong></p>`;
                html += `<ul style="font-size: 12px; color: #666; margin-left: 20px; line-height: 1.7;">`;
                html += `<li><strong>(In)</strong> = In-State California queries only - State field must be omitted</li>`;
                html += `<li><strong>(Out)</strong> = Out-of-State queries only - State field is required</li>`;
                html += `<li><strong>(In/Out)</strong> = Works for both in-state and out-of-state queries</li>`;
                html += `<li><strong>[Field]</strong> = Optional field (in brackets) - can be included but not required</li>`;
                html += `<li><strong>CA Purpose Code</strong> = Always mandatory per California AB 1747 (since July 21, 2021)</li>`;
                html += `</ul>`;
                html += `</div>`;
            }

            html += `</div>`;

            return html;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
